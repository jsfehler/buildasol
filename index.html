<script src="js/colour_conversion.js"></script>
<script src="lib/html2canvas.min.js"></script>
<script src="lib/FileSaver.min.js"></script>
<script>   
    // original: alternate
    var altSolHairPalette01 = {
        '#583b27': '#57443b', // Mid
        '#341b0f': '#312d2e', // Dark
        '#907256': '#71604b', // Light
        '#0b0401': '#0b0401' // Outline
    }

    var altSolBodyPalette01 = {
        '#ea1d1d': '#a45044', // Mid Red
        '#61031c': '#674b59', // Dark Red
        '#383838': '#2e2c2f', // Mid Grey
        '#161616': '#2e2c2f', // Dark Grey
        '#5c5c5c': '#686460', // Light Grey
        
        '#f7c697': '#f7c697', // Light Skin
        '#e8a15e': '#e3b281', // Mid Skin
        '#ba6a3f': '#916159', // Dark Skin
        '#7a4026': '#692f2d', // Dark Skin 2
        '#1c0500': '#3e1e1e' // Dark Skin 3
    }

    function scrapeColours(elementId, outputContainer) {
        // Scrape colours from an image
        var img = document.getElementById(elementId);

        // Create temp canvas to parse through image
        var canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        canvas.getContext('2d').drawImage(img, 0, 0, img.width, img.height);

        var colourData = [];

        var context = canvas.getContext('2d');
        for (var y = 0; y <= canvas.height; y++) {
            for (var x = 0; x <= canvas.width; x++) {
                var pixelData = context.getImageData(x, y, 1, 1).data;

                var pixelRGBA = [pixelData[0], pixelData[1], pixelData[2], pixelData[3]];

                var skip = false;
                // Ignore duplicate colours
                for (var j = 0; j < colourData.length; j++) {

                    if ((colourData[j][0] === pixelRGBA[0]) && (colourData[j][1] === pixelRGBA[1]) && (colourData[j][2] === pixelRGBA[2])) {
                        skip = true;
                        break;
                    }
                }

                if (skip === false) {
                    colourData.push(pixelRGBA);
                }
            }
        }

        // Delete temp canvas
        canvas.remove();

        // Create colour boxes
        var h = document.getElementById(outputContainer);
        var canvii = [];
        for (var i = 0; i < colourData.length; i++) {
            input = document.createElement('input');
            input.width = 32;
            input.height = 32;
            input.type = 'color'
            input.value = rgbToHex(colourData[i][0], colourData[i][1], colourData[i][2], colourData[i][3])
            input.id = `${outputContainer}${i}`
            input.originalColour = [colourData[i][0], colourData[i][1], colourData[i][2], colourData[i][3]];

            h.appendChild(input);

            // recolour sprite after picking
            input.addEventListener('change', function() {
                redrawPortrait('hair', 'redrawHair');
                redrawPortrait('body', 'redrawBody');
                redrawPortrait('accessory', 'redrawAccessory');
                redrawPortrait('eyes', 'redrawEyes');
                redrawPortrait('mouth', 'redrawMouth');
            })

            canvii.push(input);

            // Skip transparency
            if ((colourData[i][0] === 0) && (colourData[i][1] === 0) && (colourData[i][2] === 0) && (colourData[i][3] === 0)) {
                input.setAttribute('style', 'display:None;')
            }

        }
        // Erase previous results
        if (img.canvii !== undefined) {
            for (var i = 0; i < img.canvii.length; i++) {
                img.canvii[i].remove();
            }
        }
        img.canvii = canvii;
    }

    function redrawPortrait(elementId, outputContainer) {
        // var c = document.getElementById(outputContainer);
        var redrawCanvases = document.getElementsByClassName(outputContainer)
        redrawContext1x = redrawCanvases[0].getContext('2d')
        redrawContext2x = redrawCanvases[1].getContext('2d')

        var img = document.getElementById(elementId);
        var canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        canvas.getContext('2d').drawImage(img, 0, 0, img.width, img.height);

        for (var y = 0; y <= 80; y++) {
            for (var x = 0; x <= 64; x++) {
                data = canvas.getContext('2d').getImageData(x, y, 1, 1);
                rgba = data.data;

                // For every pixel, check if colour has been replaced

                ff = false;
                for (var z = 0; z < img.canvii.length; z++) {
                    if (rgba[0] === img.canvii[z].originalColour[0] && rgba[1] === img.canvii[z].originalColour[1] && rgba[2] === img.canvii[z].originalColour[2]) {
                        ff = hexToRgb(img.canvii[z].value)
                        ff.a = rgba[3];
                        var zz = img.canvii[z].value
                    }
                }

                if (ff) {
                    var d = redrawContext1x.createImageData(1, 1);

                    d.data[0] = ff.r;
                    d.data[1] = ff.g;
                    d.data[2] = ff.b;
                    d.data[3] = ff.a;

                    redrawContext1x.putImageData(d, x, y);
                    redrawContext2x.putImageData(d, x, y);
                    ff = false;
                }
            }
        }
    }

    function mod(n, m) {
      return ((n % m) + m) % m;
    }

    var hairStyles = [
        'assets/hair_sol_01.png',
        'assets/hair_ky_01.png',
    ]

    hairIdx = 0;

    function swapHair(direction) {
        // Wrap scrolling through items
        hairIdx = mod(hairIdx + direction, hairStyles.length);

        var elem = document.getElementById('hair');
        elem.src = hairStyles[hairIdx];
        elem.onload = function () {
            scrapeColours('hair', 'hairColours');
            redrawPortrait('hair', 'redrawHair');
        }
    }

    var eyesStyles = [
        'assets/eyes_sol_01.png',
        'assets/eyes_sol_02.png',
        'assets/eyes_ky_01.png',
    ]

    eyesIdx = 0;

    function swapEyes(direction) {
        // Wrap scrolling through items
        eyesIdx = mod(eyesIdx + direction, eyesStyles.length);

        var elem = document.getElementById('eyes');
        elem.src = eyesStyles[eyesIdx];
        elem.onload = function () {
            scrapeColours('eyes', 'eyesColours');
            redrawPortrait('eyes', 'redrawEyes');
        }
    }

    var mouthStyles = [
        'assets/mouth_sol_01.png',
        'assets/mouth_sol_02.png',
        'assets/mouth_ky_01.png',
        'assets/mouth_ky_02.png',
    ]

    mouthIdx = 0;

    function swapMouth(direction) {
        // Wrap scrolling through items
        mouthIdx = mod(mouthIdx + direction, mouthStyles.length);

        var elem = document.getElementById('mouth');
        elem.src = mouthStyles[mouthIdx];
        elem.onload = function () {
            scrapeColours('mouth', 'mouthColours');
            redrawPortrait('mouth', 'redrawMouth');
        }
    }

    var bodyStyles = [
        'assets/body_sol_01.png',
        'assets/body_ky_01.png',
    ]

    bodyIdx = 0;

    function swapBody(direction) {
        // Wrap scrolling through items
        bodyIdx = mod(bodyIdx + direction, bodyStyles.length);

        var elem = document.getElementById('body');
        elem.src = bodyStyles[bodyIdx];
        elem.onload = function () {
            scrapeColours('body', 'bodyColours');
            redrawPortrait('body', 'redrawBody');
        }
    }

    var accStyles = [
        'assets/accessory_none.png',
        'assets/accessory_sol_01.png',
    ]

    accIdx = 0;

    function swapAcc(direction) {
        // Wrap scrolling through items
        accIdx = mod(accIdx + direction, accStyles.length);

        var elem = document.getElementById('accessory');
        elem.src = accStyles[accIdx];
        elem.onload = function () {
            scrapeColours('accessory', 'accessoryColours');
            redrawPortrait('accessory', 'redrawAccessory');
        }
    }

    function downloadPortrait () {
        var elem = document.getElementById('redrawContainer');
        html2canvas(elem).then(
            (canvas) => {
                canvas.toBlob((blob) => {saveAs(blob, 'new_portrait.png')});
            }
        )
    }

    window.onload = function () {
        scrapeColours('hair', 'hairColours');
        scrapeColours('body', 'bodyColours');
        scrapeColours('accessory', 'accessoryColours');
        scrapeColours('eyes', 'eyesColours');
        scrapeColours('mouth', 'mouthColours');

        redrawPortrait('hair', 'redrawHair');
        redrawPortrait('body', 'redrawBody');
        redrawPortrait('accessory', 'redrawAccessory');
        redrawPortrait('eyes', 'redrawEyes');
        redrawPortrait('mouth', 'redrawMouth');
    }

</script>

<style>

div {
  display:inline-block;
}

#displayContainer {
  width: 100%;
  height: 185px;
  display: flex;
  margin-top: 25px;
}

#redrawContainer {
  width: 72px;
  height: 96px;
  margin: 0 auto;
}

#redrawContainer canvas {
  margin-left: 4px;
  margin-top: 7px;
}

#redrawContainer2x {
  width: 72px;
  height: 96px;
  margin: 0 auto;
  zoom: 200%;
  image-rendering: pixelated;
}

#redrawContainer2x canvas {
  margin-left: 4px;
  margin-top: 7px;
}

.redraw {
  position: absolute;
}

#pieceModContainer > div {
  display:block;
}

.styleToggle {
  vertical-align: top;
}

#downloadContainer {
  width: 100%;
}

</style>

<body>
    <div id='displayContainer'>
        <div id='redrawContainer'>
            <img src='assets/frame_1.png' class='redraw'>
            <canvas class="redraw redrawBody"></canvas>
            <canvas class="redraw redrawAccessory"></canvas>
            <canvas class="redraw redrawHair"></canvas>
            <canvas class="redraw redrawEyes"></canvas>
            <canvas class="redraw redrawMouth"></canvas>
            <img src='assets/frame_0.png' class='redraw'>
        </div>
        
        <div id='redrawContainer2x'>
            <img src='assets/frame_1.png' class='redraw'>
            <canvas class="redraw redrawBody"></canvas>
            <canvas class="redraw redrawAccessory"></canvas>
            <canvas class="redraw redrawHair"></canvas>
            <canvas class="redraw redrawEyes"></canvas>
            <canvas class="redraw redrawMouth"></canvas>
            <img src='assets/frame_0.png' class='redraw'>
        </div>

    </div>

    <div id='downloadContainer'>
        <button onclick="downloadPortrait();">Download Portrait</button>
    </div>

    <img src='assets/hair_sol_01.png' id='hair' style='display:none;'>
    <img src='assets/body_sol_01.png' id='body' style='display:none;'>
    <img src='assets/accessory_sol_01.png' id='accessory' style='display:none;'>
    <img src='assets/eyes_sol_01.png' id='eyes' style='display:none;'>
    <img src='assets/mouth_sol_01.png' id='mouth' style='display:none;'>

    <div id='pieceModContainer'>
        <div id='hairContainer'>
            <div>Hair Colours:</div>
            <button style='display:none;'>Reset</button>
            <br>
            <div id='hairColours' style='width:192px;'>
            </div>

            <div class="styleToggle">
                <div>Hair Style:</div>
                <button id='hairPrev' onclick='swapHair(-1);'><<</button>
                <button id ='hairNext' onclick='swapHair(1);'>>></button>
            </div>
        </div>

        <div id='eyesContainer'>
            <div>Eyes Colours:</div>
            <button style='display:none;'>Reset</button>
            <br>
            <div id='eyesColours' style='width:192px;'>
            </div>

            <div class="styleToggle">
                <div>Eyes Style:</div>
                <button id='eyesPrev' onclick='swapEyes(-1);'><<</button>
                <button id ='eyesNext' onclick='swapEyes(-1);'>>></button>
            </div>
        </div>

        <div id='mouthContainer'>
            <div>Mouth Colours:</div>
            <button style='display:none;'>Reset</button>
            <br>
            <div id='mouthColours' style='width:192px;'>
            </div>

            <div class="styleToggle">
                <div>Mouth Style:</div>
                <button id='mouthPrev' onclick='swapMouth(-1);'><<</button>
                <button id ='mouthNext' onclick='swapMouth(-1);'>>></button>
            </div>
        </div>

        <div id='bodyContainer'>
            <div>Body Colours:</div>
            <button style='display:none;'>Reset</button>
            
            <br>
            
            <div id='bodyColours' style='width:192px;'>
            </div>

            <div class="styleToggle">
                <div>Body Style:</div>
                <button id='bodyPrev' onclick='swapBody(-1);'><<</button>
                <button id ='bodyNext' onclick='swapBody(-1);'>>></button>
            </div>
        </div>

        <div id='accessoryContainer'>
            <div>Accessory Colours:</div>
            <button style='display:none;'>Reset</button>
            <br>
            <div id='accessoryColours' style='width:192px;'>
            </div>

            <div class="styleToggle">
                <div>Accessory Style:</div>
                <button id='accPrev' onclick='swapAcc(-1);'><<</button>
                <button id ='accNext' onclick='swapAcc(-1);'>>></button>
            </div>
        </div>
    </div>

</body>